<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Ankiç¼–è¾‘å™¨å¦‚ä½•å°†è¾“å…¥åŒæ­¥åˆ°å¯¹è±¡ - å¼ ä¹¾å¤ğŸ‘€</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Ankiç¼–è¾‘å™¨å¦‚ä½•å°†è¾“å…¥åŒæ­¥åˆ°å¯¹è±¡" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zqkgo.github.io/anki%E7%BC%96%E8%BE%91%E5%99%A8%E5%A6%82%E4%BD%95%E5%B0%86%E8%BE%93%E5%85%A5%E5%90%8C%E6%AD%A5%E5%88%B0%E5%AF%B9%E8%B1%A1/" />
<meta property="article:published_time" content="2020-12-01T05:32:02+08:00" />
<meta property="article:modified_time" content="2020-12-01T05:32:02+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ankiç¼–è¾‘å™¨å¦‚ä½•å°†è¾“å…¥åŒæ­¥åˆ°å¯¹è±¡"/>
<meta name="twitter:description" content=""/>

	
        <link href="https://zqkgo.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://zqkgo.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://zqkgo.github.io/">å¼ ä¹¾å¤ğŸ‘€</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Ankiç¼–è¾‘å™¨å¦‚ä½•å°†è¾“å…¥åŒæ­¥åˆ°å¯¹è±¡</h1>
			<div class="meta">Posted on Dec 1, 2020</div>
		</div>
		

		<section class="body">
			<pre><code>Ankiç‰ˆæœ¬ä¿¡æ¯
-----------
Tagï¼š2.1.26
Commit ID: 70784154
</code></pre><p>è®¾ç½®<code>Editor</code>çš„<code>webview</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Editor<span style="color:#f92672">.</span>__init__() <span style="color:#f92672">-&gt;</span> Editor<span style="color:#f92672">.</span>setupWeb() <span style="color:#f92672">-&gt;</span> EditorWebView(AnkiWebView)<span style="color:#f92672">.</span>__init__() <span style="color:#f92672">-&gt;</span> AnkiWebView(QWebEngineView)<span style="color:#f92672">.</span>__init__() <span style="color:#f92672">-&gt;</span> AnkiWebView<span style="color:#f92672">.</span>setPage(self<span style="color:#f92672">.</span>_page)
</code></pre></div><p><code>webview</code>éœ€è¦ä¸€ä¸ªé¡µé¢ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">self<span style="color:#f92672">.</span>_page <span style="color:#f92672">=</span> AnkiWebPage(self<span style="color:#f92672">.</span>_onBridgeCmd)
</code></pre></div><p>é€šè¿‡<a href="https://doc.qt.io/qt-5/qwebchannel.html">QWebChannel</a>å®ç°webé¡µé¢ä¸­çš„<code>JS</code>å’Œ<code>Python</code>ä¹‹é—´çš„é€šè®¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">AnkiWebPage(QWebEnginePage)<span style="color:#f92672">.</span>__init__() <span style="color:#f92672">-&gt;</span> AnkiWebPage<span style="color:#f92672">.</span>_setupBridge()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_setupBridge</span>(self):
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Bridge</span>(QObject):
        <span style="color:#a6e22e">@pyqtSlot</span>(str, result<span style="color:#f92672">=</span>str)
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cmd</span>(self, str):
            <span style="color:#75715e"># è¢«JSä»£ç è°ƒç”¨çš„æ–¹æ³•</span>
            <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>dumps(self<span style="color:#f92672">.</span>onCmd(str))

    self<span style="color:#f92672">.</span>_bridge <span style="color:#f92672">=</span> Bridge()
    self<span style="color:#f92672">.</span>_bridge<span style="color:#f92672">.</span>onCmd <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_onCmd

    self<span style="color:#f92672">.</span>_channel <span style="color:#f92672">=</span> QWebChannel(self)
    self<span style="color:#f92672">.</span>_channel<span style="color:#f92672">.</span>registerObject(<span style="color:#e6db74">&#34;py&#34;</span>, self<span style="color:#f92672">.</span>_bridge)
    self<span style="color:#f92672">.</span>setWebChannel(self<span style="color:#f92672">.</span>_channel)

    js <span style="color:#f92672">=</span> QFile(<span style="color:#e6db74">&#34;:/qtwebchannel/qwebchannel.js&#34;</span>)
    <span style="color:#66d9ef">assert</span> js<span style="color:#f92672">.</span>open(QIODevice<span style="color:#f92672">.</span>ReadOnly)
    js <span style="color:#f92672">=</span> bytes(js<span style="color:#f92672">.</span>readAll())<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)

    script <span style="color:#f92672">=</span> QWebEngineScript()
    script<span style="color:#f92672">.</span>setSourceCode(
        js
        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        var pycmd;
</span><span style="color:#e6db74">        new QWebChannel(qt.webChannelTransport, function(channel) {
</span><span style="color:#e6db74">            // å‘pythonå‘é€æ¶ˆæ¯
</span><span style="color:#e6db74">            pycmd = function (arg, cb) {
</span><span style="color:#e6db74">                var resultCB = function (res) {
</span><span style="color:#e6db74">                    // pass result back to user-provided callback
</span><span style="color:#e6db74">                    if (cb) {
</span><span style="color:#e6db74">                        cb(JSON.parse(res));
</span><span style="color:#e6db74">                    }
</span><span style="color:#e6db74">                }
</span><span style="color:#e6db74">                // è°ƒç”¨åç§°ä¸º&#34;py&#34;çš„å¯¹è±¡çš„cmdæ–¹æ³•
</span><span style="color:#e6db74">                channel.objects.py.cmd(arg, resultCB);
</span><span style="color:#e6db74">                return false;                   
</span><span style="color:#e6db74">            }
</span><span style="color:#e6db74">            pycmd(&#34;domDone&#34;);
</span><span style="color:#e6db74">        });
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    )
    script<span style="color:#f92672">.</span>setWorldId(QWebEngineScript<span style="color:#f92672">.</span>MainWorld)
    script<span style="color:#f92672">.</span>setInjectionPoint(QWebEngineScript<span style="color:#f92672">.</span>DocumentReady)
    script<span style="color:#f92672">.</span>setRunsOnSubFrames(False)
    self<span style="color:#f92672">.</span>profile()<span style="color:#f92672">.</span>scripts()<span style="color:#f92672">.</span>insert(script)
</code></pre></div><p>å½“å­—æ®µå†…å®¹æ›´æ–°æ—¶ï¼Œ<code>JS</code>éœ€è¦é€šçŸ¥<code>Python</code>ï¼š</p>
<pre><code>editor.js
---------
function setFields(fields) {
    let txt = &quot;&quot;;
    for (let i = 0; i &lt; fields.length; i++) {
        const n = fields[i][0];
        let f = fields[i][1];
        if (!f) {
            f = &quot;&lt;br&gt;&quot;;
        }
        txt += `
        &lt;tr&gt;
            &lt;td class=fname id=&quot;name${i}&quot;&gt;${n}&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td width=100%&gt;
                &lt;div id=f${i}
                     onkeydown='onKey(window.event);'
                     oninput='onInput();'
                     onmouseup='onKey(window.event);'
                     &lt;!----&gt;
                     onfocus='onFocus(this);'
                     onblur='onBlur();'
                     class='field clearfix'
                     ondragover='onDragOver(this);'
                     onpaste='onPaste(this);'
                     oncopy='onCutOrCopy(this);'
                     oncut='onCutOrCopy(this);'
                     contentEditable=true
                     class=field
                &gt;${f}&lt;/div&gt;
            &lt;/td&gt;
        &lt;/tr&gt;`;
    }
    $(&quot;#fields&quot;).html(`
    &lt;table cellpadding=0 width=100% style='table-layout: fixed;'&gt;
${txt}
    &lt;/table&gt;`);
    maybeDisableButtons();
}

function onBlur() {
    if (!currentField) {
        return;
    }
    // å½“å‰è¾“å…¥æ¡†å†…å®¹å˜åŒ–ï¼Œæˆ–å…‰æ ‡å¤±ç„¦ï¼Œå‘é€äº‹ä»¶åˆ°Anki
    if (document.activeElement === currentField) {
        // other widget or window focused; current field unchanged
        saveField(&quot;key&quot;);
    }
    else {
        saveField(&quot;blur&quot;);
        currentField = null;
        disableButtons();
    }
}

// å…³é”®å‡½æ•°
function saveField(type) {
    clearChangeTimer();
    if (!currentField) {
        // no field has been focused yet
        return;
    }
    // type is either 'blur' or 'key'
    pycmd(type +
        &quot;:&quot; +
        currentFieldOrdinal() +
        &quot;:&quot; +
        currentNoteId +
        &quot;:&quot; +
        currentField.innerHTML);
}
</code></pre><p>æ­¤æ—¶<code>JS</code>å¯é€šè¿‡<code>pycmd()</code>å‡½æ•°å‘<code>Python</code>å‘é€äº‹ä»¶ï¼Œäº‹ä»¶å¤„ç†è·¯å¾„ï¼š</p>
<pre><code>Bridge.cmd()
  -&gt; AnkiWebPage._onCmd()
    -&gt; AnkiWebView._onBridgeCmd()
      -&gt; å¤„ç†domDoneäº‹ä»¶
      -&gt; Editor.onBridgeCmd()
</code></pre><p>å½“è¾“å…¥æ¡†æ›´æ–°æ—¶ï¼Œ<code>Editor.onBridgeCmd()</code>ä¼šæ”¶åˆ°æ¥è‡ª<code>JS</code>çš„äº‹ä»¶<code>cmd</code>ï¼Œå…¶æ ¼å¼ç±»ä¼¼äºï¼š</p>
<pre><code>key:0:1606804714569:å¤ªé˜³è·åœ°è·ç¦»ï¼Ÿ
key:1:1606804714569:1.496*10^8åƒç±³
blur:1:1606804714569:1.496*10^8åƒç±³
</code></pre><p><code>Anki</code>æŒ‰ç…§çº¦å®šçš„æ ¼å¼è¿›è¡Œè§£æï¼Œä¿å­˜åˆ°<code>Editor.note</code>å¯¹è±¡ã€‚</p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/anki">anki</a></li>
					
				</ul>
			</nav>
			
			
		</div>
	</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2023  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


</div>
    </body>
</html>
